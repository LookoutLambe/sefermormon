<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1628">
<link rel="manifest" href="manifest.json">
<title>ספר מורמון — עדות אחרת ישוע המשיח</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;500;700;900&family=Noto+Serif+Hebrew:wght@300;400;500;700&family=David+Libre:wght@400;500;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{--cream:#f5f0e4;--cream-dark:#e8e0d0;--cream-mid:#ede6d8;--navy:#0a1628;--navy-soft:#2a3a52;--gold:#b8943f;--gold-light:#c9a84c;--gold-dim:rgba(184,148,63,.25);--text:#1a1a1a;--text-mid:#3a3530;--text-dim:#8a8072;--text-light:#b0a898;--font-size:18px;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--cream);color:var(--text);font-family:'David Libre','Noto Serif Hebrew','Frank Ruhl Libre',serif}

.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--navy);padding:calc(var(--safe-top)+8px) 12px 12px;display:flex;align-items:center;gap:10px}
.nav-btn{background:none;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8);width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .2s;flex-shrink:0}
.nav-btn:active{background:rgba(255,255,255,.1)}
.nav-loc{flex:1;text-align:center;cursor:pointer;padding:4px 8px;border-radius:8px}
.nav-loc:active{background:rgba(255,255,255,.1)}
.nav-book{font-size:15px;color:#fff;font-weight:500;line-height:1.3}
.nav-ref{font-size:11px;color:rgba(255,255,255,.5);line-height:1.3}

.pane{position:fixed;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:calc(var(--safe-top)+76px) 12px calc(var(--safe-bottom)+72px);scroll-behavior:smooth}
.pane::-webkit-scrollbar{width:3px}
.pane::-webkit-scrollbar-thumb{background:var(--cream-dark);border-radius:2px}

.ch-head{text-align:center;padding:24px 0 18px;margin-bottom:20px}
.ch-head::after{content:'';display:block;width:50px;height:1px;background:var(--gold);margin:16px auto 0}
.ch-head h1{font-size:26px;color:var(--navy);font-weight:500}
.ch-head h2{font-size:14px;color:var(--text-dim);font-weight:300;margin-top:2px}

/* ═══ BILINGUAL ROWS ═══ */
.v-row{display:flex;gap:0;margin-bottom:2px;border-bottom:1px solid rgba(0,0,0,.04);min-height:auto}
.v-row:last-child{border-bottom:none}
.v-row:active,.v-row.hl{background:rgba(184,148,63,.08)}
.v-row.inter,.p-row.inter{flex-direction:column;gap:0}
.v-row.inter .v-heb,.p-row.inter .p-heb{padding-bottom:2px}
.v-row.inter .v-eng,.p-row.inter .p-eng{padding-top:2px;font-size:calc(var(--font-size) - 2px)}
.inter-line{display:flex;flex-wrap:wrap;direction:rtl;justify-content:center;gap:6px 14px;padding:10px 8px}
.inter-word{display:inline-flex;flex-direction:column;align-items:center;gap:2px}
.inter-word .iw-h{font-family:'David Libre','Noto Serif Hebrew',serif;font-size:var(--font-size);direction:rtl;color:var(--text)}
.inter-word .iw-e{font-family:'Cormorant Garamond',serif;font-size:calc(var(--font-size) - 5px);color:var(--text-dim);direction:ltr;text-align:center;line-height:1.2;min-height:1em}
.inter-line{display:flex;flex-wrap:wrap;direction:rtl;justify-content:center;gap:6px 14px;padding:10px 8px}
.inter-word{display:flex;flex-direction:column;align-items:center;gap:2px}
.inter-word .iw-h{font-family:'David Libre','Noto Serif Hebrew',serif;font-size:var(--font-size);direction:rtl;color:var(--text);line-height:1.3}
.inter-word .iw-e{font-family:'Cormorant Garamond',serif;font-size:calc(var(--font-size) - 5px);color:var(--text-dim);direction:ltr;text-align:center;line-height:1.2}

.v-heb{flex:1;padding:10px 10px 10px 8px;font-size:var(--font-size);line-height:2;direction:rtl;text-align:justify;font-family:'David Libre','Noto Serif Hebrew','Frank Ruhl Libre',serif}
.v-eng{flex:1;padding:10px 8px 10px 10px;font-size:calc(var(--font-size) - 1px);line-height:1.8;direction:ltr;text-align:justify;color:var(--text-mid);font-family:'Cormorant Garamond',serif}
.vn{font-size:.7em;color:var(--gold);font-weight:700;vertical-align:super;margin-left:3px;margin-right:3px;user-select:none}

/* Prose bilingual rows (front matter) */
.p-row{display:flex;gap:0;margin-bottom:4px;border-bottom:1px solid rgba(0,0,0,.03)}
.p-row:last-child{border-bottom:none}
.p-heb{flex:1;padding:8px 10px 8px 8px;font-size:var(--font-size);line-height:2.1;direction:rtl;text-align:justify;font-family:'David Libre','Noto Serif Hebrew','Frank Ruhl Libre',serif}
.p-eng{flex:1;padding:8px 8px 8px 10px;font-size:calc(var(--font-size) - 1px);line-height:1.8;direction:ltr;text-align:justify;color:var(--text-mid);font-family:'Cormorant Garamond',serif}



.prose{font-size:var(--font-size);line-height:2.2;color:var(--text)}
.prose p{margin-bottom:14px}
.summary{font-size:calc(var(--font-size) - 2px);line-height:1.9;color:var(--text-dim);font-style:italic;padding:0 8px 16px;border-bottom:1px solid var(--gold-dim);margin-bottom:16px}

.gloss-entry{margin-bottom:16px;padding:12px 16px;background:var(--cream-mid);border-radius:10px;border-right:3px solid var(--gold)}
.gloss-heb{font-size:19px;color:var(--navy);font-weight:500}
.gloss-renders{font-size:13px;color:var(--text-mid)}
.gloss-ref{font-size:12px;color:var(--gold);margin:2px 0;direction:ltr;text-align:left}
.gloss-desc{font-size:14px;color:var(--text-mid);line-height:1.7;margin-top:6px;direction:ltr;text-align:left}

.ch-nav{display:flex;justify-content:space-between;padding:28px 0;border-top:1px solid var(--gold-dim);margin-top:28px}
.ch-nav-btn{background:var(--cream-mid);border:1px solid var(--cream-dark);color:var(--text-mid);padding:10px 18px;border-radius:10px;cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s;max-width:48%;text-align:center}
.ch-nav-btn:active{background:var(--cream-dark)}

.bot{position:fixed;bottom:0;left:0;right:0;z-index:100;background:linear-gradient(0deg,var(--cream) 0%,var(--cream) 75%,transparent);padding:14px 12px calc(var(--safe-bottom)+10px);display:flex;justify-content:center;gap:6px}
.bot-btn{background:var(--cream-mid);border:1px solid var(--cream-dark);color:var(--text-mid);padding:7px 14px;border-radius:20px;cursor:pointer;font-family:inherit;font-size:13px;display:flex;align-items:center;gap:5px;transition:all .2s}
.bot-btn:active{background:var(--cream-dark)}
.bot-btn svg{width:15px;height:15px}
.bot-btn.active{background:var(--gold-dim);border-color:var(--gold)}



.ov{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;opacity:0;pointer-events:none;transition:opacity .25s}
.ov.on{opacity:1;pointer-events:auto}
.pan{position:fixed;bottom:0;left:0;right:0;max-height:85vh;background:var(--cream);border-top:1px solid var(--cream-dark);border-radius:20px 20px 0 0;z-index:201;transform:translateY(100%);transition:transform .3s cubic-bezier(.22,1,.36,1);overflow:hidden;display:flex;flex-direction:column;box-shadow:0 -4px 20px rgba(0,0,0,.1)}
.pan.on{transform:translateY(0)}
.pan-grip{width:36px;height:3px;background:var(--cream-dark);border-radius:2px;margin:10px auto 6px}
.pan-hd{padding:6px 20px 10px;border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.pan-t{font-size:17px;color:var(--navy);font-weight:500}
.pan-x{background:none;border:none;color:var(--text-dim);font-size:22px;cursor:pointer;padding:4px 8px}
.pan-bd{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:14px 20px calc(var(--safe-bottom)+20px);flex:1}

.bk-grp{font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:2px;padding:14px 0 6px}
.bk{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background .15s;margin-bottom:1px}
.bk:active,.bk.cur{background:var(--cream-mid)}
.bk-name{font-size:16px;color:var(--text)}
.bk-en{font-size:11px;color:var(--text-dim);margin-top:1px}
.bk-ch{font-size:11px;color:var(--text-dim)}

.ch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:7px;padding:8px 0}
.ch-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:1px solid var(--cream-dark);border-radius:10px;cursor:pointer;font-size:14px;color:var(--text-mid);transition:all .15s}
.ch-cell:active,.ch-cell.cur{background:var(--cream-mid);border-color:var(--gold);color:var(--navy);font-weight:700}

.s-in{width:100%;background:var(--cream-mid);border:1px solid var(--cream-dark);border-radius:12px;padding:11px 14px;font-family:inherit;font-size:16px;color:var(--text);outline:none;direction:rtl;margin-bottom:14px}
.s-in:focus{border-color:var(--gold)}
.s-in::placeholder{color:var(--text-light)}
.s-cnt{font-size:11px;color:var(--text-dim);margin-bottom:10px}
.s-r{padding:10px 14px;border-radius:10px;cursor:pointer;transition:background .15s;margin-bottom:3px}
.s-r:active{background:var(--cream-mid)}
.s-ref{font-size:12px;color:var(--gold);margin-bottom:3px}
.s-snip{font-size:14px;color:var(--text);line-height:1.6}
.s-snip mark{background:rgba(184,148,63,.2);color:var(--navy);border-radius:2px;padding:0 2px}

.home{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 140px);text-align:center;padding:40px 28px}
.home-t{font-family:'Frank Ruhl Libre',serif;font-size:42px;color:var(--navy);font-weight:900;line-height:1.3}
.home-sub{font-size:17px;color:var(--text-dim);font-weight:300;margin-top:6px}
.home-by{font-size:13px;color:var(--text-light);margin-top:6px}
.home-sep{width:50px;height:1px;background:var(--gold);margin:32px auto}
.home-btn{background:transparent;border:2px solid var(--navy);color:var(--navy);padding:13px 36px;border-radius:28px;font-family:inherit;font-size:16px;cursor:pointer;transition:all .25s}
.home-btn:active{background:var(--navy);color:var(--cream)}

.fade{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@media(min-width:1024px){.pane{max-width:960px;margin:0 auto;padding-left:24px;padding-right:24px}}
@media(min-width:768px) and (max-width:1023px){.pane{max-width:760px;margin:0 auto}}
</style>
</head>
<body>
<div class="nav" id="nav" style="display:none">
  <button class="nav-btn" onclick="openBooks()">☰</button>
  <div class="nav-loc" onclick="openChapPick()">
    <div class="nav-book" id="navBook"></div>
    <div class="nav-ref" id="navRef"></div>
  </div>
  <button class="nav-btn" onclick="openSearch()">⌕</button>
</div>
<div class="pane" id="pane"><div id="content"></div></div>
<div class="bot" id="bot" style="display:none">
  <button class="bot-btn" onclick="adjFont(-2)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>א</button>
  <button class="bot-btn" onclick="adjFont(2)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>א</button>
  <button class="bot-btn" id="btnLang" onclick="toggleLang()">EN|עב</button>

  <button class="bot-btn" id="btnPrev" onclick="prevCh()" style="display:none">→</button>
  <button class="bot-btn" id="btnNext" onclick="nextCh()" style="display:none">←</button>
</div>

<div class="ov" id="ov" onclick="closePanel()"></div>
<div class="pan" id="booksPan">
  <div class="pan-grip"></div>
  <div class="pan-hd"><span class="pan-t">תוכן עניינים</span><button class="pan-x" onclick="closePanel()">×</button></div>
  <div class="pan-bd" id="booksList"></div>
</div>
<div class="pan" id="chapPan">
  <div class="pan-grip"></div>
  <div class="pan-hd"><span class="pan-t" id="chapPanT"></span><button class="pan-x" onclick="closePanel()">×</button></div>
  <div class="pan-bd" id="chapGrid"></div>
</div>
<div class="pan" id="searchPan">
  <div class="pan-grip"></div>
  <div class="pan-hd"><span class="pan-t">חיפוש</span><button class="pan-x" onclick="closePanel()">×</button></div>
  <div class="pan-bd">
    <input type="search" class="s-in" id="sInput" placeholder="...הקלד לחיפוש" oninput="doSearch(this.value)">
    <div class="s-cnt" id="sCnt"></div>
    <div id="sRes"></div>
  </div>
</div>
<script src="bom_data.js"></script>
<script>
'use strict';
let view='home',fmIdx=-1,bookIdx=-1,chapNum=null,fontSize=18,langMode='both';
const $=id=>document.getElementById(id);
function intToHeb(n){if(n<=0)return'';const t=['','י','כ','ל','מ','נ','ס','ע','פ','צ'],o=['','א','ב','ג','ד','ה','ו','ז','ח','ט'];if(n===15)return'טו';if(n===16)return'טז';let r='';if(n>=400){r+='ת';n-=400;}if(n>=100){r+=['','ק','ר','ש','ת'][~~(n/100)];n%=100;}if(n>=10){r+=t[~~(n/10)];n%=10;}if(n>0)r+=o[n];return r;}
function sortedChs(b){return Object.keys(b.chapters).map(Number).sort((a,c)=>a-c);}
const groups=[{label:'הקדמות ועדויות',type:'fm'},{label:'לוחות קטנות',ids:['1nephi','2nephi','jacob','enos','jarom','omni']},{label:'לוחות גדולות',ids:['wom','mosiah','alma','helaman','3nephi','4nephi','mormon']},{label:'ספרים נוספים',ids:['ether','moroni']},{label:'מילון מונחים',type:'glossary'}];

function toggleLang(){
  if(langMode==='both')langMode='inter';
  else if(langMode==='inter')langMode='heb';
  else if(langMode==='heb')langMode='eng';
  else langMode='both';
  $('btnLang').textContent=langMode==='both'?'EN|עב':langMode==='inter'?'⇅':langMode==='heb'?'עב':'EN';
  $('btnLang').classList.toggle('active',langMode!=='both');
  if(view==='ch'&&bookIdx>=0)loadCh(bookIdx,chapNum);
  else if(view==='fm'&&fmIdx>=0)loadFM(fmIdx);
}

function init(){buildBooksList();showHome();document.addEventListener('keydown',e=>{if(e.key==='ArrowRight')prevCh();if(e.key==='ArrowLeft')nextCh();if(e.key==='Escape')closePanel();});}
function showHome(){view='home';$('nav').style.display='none';$('bot').style.display='none';$('content').innerHTML='<div class="home fade"><div class="home-t">ספר מורמון</div><div class="home-sub">עדות אחרת ישוע המשיח</div><div class="home-by">תרגם ללשון המקרא בידי כריס לאמב · תשפ״ו</div><div class="home-sep"></div><button class="home-btn" onclick="openBooks()">פתח את הספר</button></div>';}

function buildBooksList(){let h='';for(const g of groups){h+='<div class="bk-grp">'+g.label+'</div>';if(g.type==='fm'){for(let i=0;i<FRONT_MATTER.length;i++){const fm=FRONT_MATTER[i],c=view==='fm'&&fmIdx===i?'cur':'';h+='<div class="bk '+c+'" onclick="loadFM('+i+')"><div><div class="bk-name">'+fm.title_heb+'</div><div class="bk-en">'+fm.title_en+'</div></div></div>';}}else if(g.type==='glossary'){for(let i=0;i<GLOSSARY.length;i++){const gl=GLOSSARY[i],c=view==='glossary'&&fmIdx===i?'cur':'';h+='<div class="bk '+c+'" onclick="loadGloss('+i+')"><div><div class="bk-name" style="direction:ltr;text-align:left;font-size:14px">'+gl.title+'</div></div></div>';}}else{for(const id of g.ids){const b=BOM_DATA.find(x=>x.id===id);if(!b)continue;const bi=BOM_DATA.indexOf(b),cc=Object.keys(b.chapters).length,c=view==='ch'&&bi===bookIdx?'cur':'';h+='<div class="bk '+c+'" onclick="selBook(\''+id+'\')"><div><div class="bk-name">'+b.name_heb+'</div><div class="bk-en">'+b.name_en+'</div></div><div class="bk-ch">'+(cc>1?cc+' פרקים':'פרק אחד')+'</div></div>';}}}$('booksList').innerHTML=h;}

function loadFM(idx){
  closePanel();view='fm';fmIdx=idx;bookIdx=-1;chapNum=null;
  const fm=FRONT_MATTER[idx];
  const fmp=(typeof FM_PAIRS!=='undefined')?FM_PAIRS[idx]:null;
  showNav();$('navBook').textContent=fm.title_heb;$('navRef').textContent=fm.title_en;
  let h='<div class="ch-head fade"><h1>'+fm.title_heb+'</h1><h2>'+fm.title_en+'</h2></div><div class="fade">';
  if(fmp&&fmp.pairs){
    for(const p of fmp.pairs){
      if(langMode==='heb'){
        h+='<div class="p-row"><div class="p-heb" style="border:none">'+p.heb+'</div></div>';
      }else if(langMode==='eng'){
        h+='<div class="p-row"><div class="p-eng" style="border:none;flex:1">'+p.eng+'</div></div>';
      }else if(langMode==='inter'){
        h+=interlinearHTML(p.heb,'','');
      }else{
        h+='<div class="p-row"><div class="p-eng">'+p.eng+'</div><div class="p-heb">'+p.heb+'</div></div>';
      }
    }
  }else{
    const pars=fm.content.split('\n').filter(p=>p.trim());
    for(const p of pars) h+='<div class="p-row"><div class="p-heb" style="border:none">'+p+'</div></div>';
  }
  h+='</div><div class="ch-nav">';
  if(idx<FRONT_MATTER.length-1)h+='<button class="ch-nav-btn" onclick="loadFM('+(idx+1)+')">'+FRONT_MATTER[idx+1].title_heb+' ←</button>';
  else{const b=BOM_DATA[0],c=sortedChs(b)[0];h+='<button class="ch-nav-btn" onclick="loadCh(0,'+c+')">'+b.name_heb+' ←</button>';}
  if(idx>0)h+='<button class="ch-nav-btn" onclick="loadFM('+(idx-1)+')">→ '+FRONT_MATTER[idx-1].title_heb+'</button>';
  else h+='<div></div>';
  h+='</div>';$('content').innerHTML=h;$('pane').scrollTop=0;updBot();buildBooksList();
}

function loadGloss(idx){closePanel();view='glossary';fmIdx=idx;bookIdx=-1;chapNum=null;const gl=GLOSSARY[idx];showNav();$('navBook').textContent=gl.title;$('navRef').textContent='מילון מונחים';let h='<div class="ch-head fade"><h1 style="font-size:20px;direction:ltr">'+gl.title+'</h1><h2>מילון מונחים</h2></div><div class="fade">';let entries=gl.entries,i=0;while(i<entries.length){const line=entries[i];if(/[\u0590-\u05FF]/.test(line)&&/[a-zA-Zʾāōēûîĕ]/.test(line)){let e={heb:line,renders:'',ref:'',desc:''};i++;while(i<entries.length){if(entries[i].startsWith('Renders:')){e.renders=entries[i].substring(9).trim();i++;}else if(entries[i].startsWith('BH:')){e.ref=entries[i];i++;}else if(/[\u0590-\u05FF]/.test(entries[i])&&/[a-zA-Zʾāōēûîĕ]/.test(entries[i]))break;else{e.desc+=(e.desc?' ':'')+entries[i];i++;}}h+='<div class="gloss-entry"><div class="gloss-heb">'+e.heb+'</div>';if(e.renders)h+='<div class="gloss-renders">→ '+e.renders+'</div>';if(e.ref)h+='<div class="gloss-ref">'+e.ref+'</div>';if(e.desc)h+='<div class="gloss-desc">'+e.desc+'</div>';h+='</div>';}else{h+='<div class="prose" style="direction:ltr;text-align:left;margin-bottom:12px"><p>'+line+'</p></div>';i++;}}h+='</div><div class="ch-nav">';if(idx<GLOSSARY.length-1)h+='<button class="ch-nav-btn" style="direction:ltr" onclick="loadGloss('+(idx+1)+')">'+GLOSSARY[idx+1].title+' →</button>';else h+='<div></div>';if(idx>0)h+='<button class="ch-nav-btn" style="direction:ltr" onclick="loadGloss('+(idx-1)+')">← '+GLOSSARY[idx-1].title+'</button>';else h+='<div></div>';h+='</div>';$('content').innerHTML=h;$('pane').scrollTop=0;updBot();buildBooksList();}

function selBook(id){const bi=BOM_DATA.findIndex(b=>b.id===id);if(bi<0)return;const b=BOM_DATA[bi],chs=sortedChs(b);if(chs.length===1){loadCh(bi,chs[0]);return;}closePanel();bookIdx=bi;$('chapPanT').textContent=b.name_heb;let h='<div class="ch-grid">';for(const c of chs){const cur=chapNum===c&&bookIdx===bi?'cur':'';h+='<div class="ch-cell '+cur+'" onclick="loadCh('+bi+','+c+')">'+intToHeb(c)+'</div>';}h+='</div>';$('chapGrid').innerHTML=h;openPanel('chapPan');}

function loadCh(bi,ch){
  closePanel();view='ch';bookIdx=bi;chapNum=ch;fmIdx=-1;
  const b=BOM_DATA[bi],verses=b.chapters[String(ch)];if(!verses)return;
  const engCh=(typeof ENG_DATA!=='undefined'&&ENG_DATA[b.id])?ENG_DATA[b.id][String(ch)]||{}:{};
  showNav();$('navBook').textContent=b.name_heb;
  const chs=sortedChs(b);$('navRef').textContent=chs.length>1?'פרק '+intToHeb(ch):'';
  let h='<div style="height:48px"></div>';
  if(b.summary&&ch===chs[0])h+='<div class="summary fade">'+b.summary+'</div>';
  h+='<div class="fade">';
  const vNums=Object.keys(verses).map(Number).sort((a,c)=>a-c);
  for(const v of vNums){
    const hText=verses[String(v)];
    const eText=engCh[String(v)]||'';
    const vHeb=intToHeb(v);
    if(langMode==='heb'){
      h+='<div class="v-row" onclick="this.classList.toggle(\'hl\')"><div class="v-heb" style="border:none"><span class="vn">'+vHeb+'</span> '+hText+'</div></div>';
    }else if(langMode==='eng'){
      h+='<div class="v-row" onclick="this.classList.toggle(\'hl\')"><div class="v-eng" style="border:none;flex:1"><span class="vn">'+v+'</span> '+eText+'</div></div>';
    }else if(langMode==='inter'){
      h+=interlinearHTML(hText,vHeb,v);
    }else{
      h+='<div class="v-row" onclick="this.classList.toggle(\'hl\')"><div class="v-eng"><span class="vn">'+v+'</span> '+eText+'</div><div class="v-heb"><span class="vn">'+vHeb+'</span> '+hText+'</div></div>';
    }
  }
  h+='</div>';
  const ci=chs.indexOf(ch);h+='<div class="ch-nav">';
  if(ci<chs.length-1)h+='<button class="ch-nav-btn" onclick="loadCh('+bi+','+chs[ci+1]+')">פרק '+intToHeb(chs[ci+1])+' ←</button>';
  else if(bi<BOM_DATA.length-1){const nb=BOM_DATA[bi+1],nc=sortedChs(nb)[0];h+='<button class="ch-nav-btn" onclick="loadCh('+(bi+1)+','+nc+')">'+nb.name_heb+' ←</button>';}else h+='<div></div>';
  if(ci>0)h+='<button class="ch-nav-btn" onclick="loadCh('+bi+','+chs[ci-1]+')">→ פרק '+intToHeb(chs[ci-1])+'</button>';
  else if(bi>0){const pb=BOM_DATA[bi-1],pc=sortedChs(pb);h+='<button class="ch-nav-btn" onclick="loadCh('+(bi-1)+','+pc[pc.length-1]+')">→ '+pb.name_heb+'</button>';}else h+='<div></div>';
  h+='</div>';$('content').innerHTML=h;$('pane').scrollTop=0;updBot();buildBooksList();
}

function prevCh(){if(view!=='ch'||bookIdx<0)return;const chs=sortedChs(BOM_DATA[bookIdx]),ci=chs.indexOf(chapNum);if(ci>0)loadCh(bookIdx,chs[ci-1]);else if(bookIdx>0){const pb=BOM_DATA[bookIdx-1],pc=sortedChs(pb);loadCh(bookIdx-1,pc[pc.length-1]);}}
function nextCh(){if(view!=='ch'||bookIdx<0)return;const chs=sortedChs(BOM_DATA[bookIdx]),ci=chs.indexOf(chapNum);if(ci<chs.length-1)loadCh(bookIdx,chs[ci+1]);else if(bookIdx<BOM_DATA.length-1){const nb=BOM_DATA[bookIdx+1],nc=sortedChs(nb)[0];loadCh(bookIdx+1,nc);}}

function updBot(){
  const isCh=view==='ch';
  $('btnPrev').style.display=isCh?'':'none';
  $('btnNext').style.display=isCh?'':'none';
  $('btnLang').style.display=(isCh||view==='fm')?'':'none';
}
function showNav(){$('nav').style.display='flex';$('bot').style.display='flex';}
function adjFont(d){fontSize=Math.max(12,Math.min(36,fontSize+d));document.documentElement.style.setProperty('--font-size',fontSize+'px');}

let sTimer=null;
function doSearch(q){clearTimeout(sTimer);if(q.length<2){$('sRes').innerHTML='';$('sCnt').textContent='';return;}sTimer=setTimeout(()=>{const res=[];for(const b of BOM_DATA){for(const[ch,vs] of Object.entries(b.chapters)){for(const[v,txt] of Object.entries(vs)){if(txt.includes(q)){res.push({bk:b.name_heb,bi:BOM_DATA.indexOf(b),ch:Number(ch),v:Number(v),txt});if(res.length>=80)break;}}if(res.length>=80)break;}if(res.length>=80)break;}$('sCnt').textContent=res.length>=80?'80+ תוצאות':res.length+' תוצאות';let h='';const esc=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');for(const r of res.slice(0,40)){const snip=r.txt.length>120?r.txt.substring(0,120)+'…':r.txt;const mk=snip.replace(new RegExp(esc,'g'),'<mark>'+q+'</mark>');h+='<div class="s-r" onclick="closePanel();loadCh('+r.bi+','+r.ch+')"><div class="s-ref">'+r.bk+' '+intToHeb(r.ch)+':'+intToHeb(r.v)+'</div><div class="s-snip">'+mk+'</div></div>';}$('sRes').innerHTML=h;},200);}

let activePanel=null;
function openPanel(id){closePanel();activePanel=$(id);$('ov').classList.add('on');activePanel.classList.add('on');}
function closePanel(){$('ov').classList.remove('on');if(activePanel){activePanel.classList.remove('on');activePanel=null;}}
function openBooks(){buildBooksList();openPanel('booksPan');}
function openChapPick(){if(bookIdx>=0)selBook(BOM_DATA[bookIdx].id);}
function openSearch(){openPanel('searchPan');setTimeout(()=>$('sInput').focus(),300);}

// Interlinear glossary lookup
function _sn(s){return s.replace(/[\u0591-\u05C7]/g,'').replace(/[־׃:.,]/g,'');}
function interlinearHTML(hText,vHeb,vNum){
  const clean=hText.replace(/[׃:]+\s*$/,'').trim();
  const tokens=[];
  clean.split(/\s+/).forEach(w=>{
    w.split('־').forEach(p=>{if(p.trim())tokens.push(p.trim());});
  });
  if(!tokens.length)return '';
  const GL=(typeof HEB_GLOSS!=='undefined')?HEB_GLOSS:{};
  let s='<div class="v-row" onclick="this.classList.toggle(\'hl\')"><div class="inter-line">';
  if(vHeb)s+='<div class="inter-word"><div class="iw-h" style="color:var(--gold);font-weight:700;font-size:.75em">'+vHeb+'</div><div class="iw-e" style="color:var(--gold);font-size:.6em">'+vNum+'</div></div>';
  for(const t of tokens){
    const base=_sn(t);
    const g=GL[base]||HEB_DICT[base]||'';
    s+='<div class="inter-word"><div class="iw-h">'+t+'</div><div class="iw-e">'+g+'</div></div>';
  }
  s+='</div></div>';
  return s;
}

init();
</script>
</body>
</html>
